---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort((a, b) => 
  b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const baseUrl = import.meta.env.BASE_URL;
// Ensure base URL ends with / for proper path joining
const getUrl = (path: string) => {
  const cleanBase = baseUrl.endsWith('/') ? baseUrl : `${baseUrl}/`;
  const cleanPath = path.startsWith('/') ? path.slice(1) : path;
  return `${cleanBase}${cleanPath}`;
};
// Helper to get image URL with base path
const getImageUrl = (imagePath: string) => {
  if (!imagePath) return '';
  // If path already starts with base, return as is
  if (imagePath.startsWith(baseUrl)) return imagePath;
  // If path starts with /, prepend base (removing leading /)
  if (imagePath.startsWith('/')) {
    const cleanBase = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
    return `${cleanBase}${imagePath}`;
  }
  // Otherwise, treat as relative path
  return getUrl(imagePath);
};
---

<BaseLayout title="Blog">
  <div class="container">
    <header class="page-header">
      <h1>All Blog Posts</h1>
      <p>Explore all our technology articles and tutorials.</p>
    </header>

    {posts.length > 0 ? (
      <div class="posts-list">
        {posts.map((post) => (
          <article class="post-item">
            <a href={getUrl(`blog/${post.slug}`)}>
              {post.data.image && (
                <div class="post-item-image">
                  <img 
                    src={getImageUrl(post.data.image)} 
                    alt={post.data.imageAlt || post.data.title}
                    loading="lazy"
                  />
                </div>
              )}
              <div class="post-item-content">
                <h2>{post.data.title}</h2>
                <p class="post-excerpt">{post.data.description}</p>
              <div class="post-meta">
                <time datetime={post.data.pubDate.toISOString()}>
                  {post.data.pubDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </time>
                <span class="separator">•</span>
                <span>{post.data.author}</span>
                {post.data.tags.length > 0 && (
                  <>
                    <span class="separator">•</span>
                    <div class="tags">
                      {post.data.tags.map((tag) => (
                        <span class="tag">{tag}</span>
                      ))}
                    </div>
                  </>
                )}
              </div>
              </div>
            </a>
          </article>
        ))}
      </div>
    ) : (
      <div class="empty-state">
        <p>No blog posts yet. Check back soon!</p>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  .page-header {
    margin-bottom: var(--md-spacing-unit--4xl);
    text-align: center;
  }

  .page-header h1 {
    margin-bottom: var(--md-spacing-unit--sm);
  }

  .page-header p {
    color: var(--blog-text-muted);
    font-size: var(--md-font-size--lg);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: var(--md-spacing-unit--xl);
    max-width: var(--blog-content-width);
    margin: 0 auto;
  }

  .post-item {
    padding: 0;
    border: 1px solid var(--blog-border);
    border-radius: var(--md-border-radius--lg);
    overflow: hidden;
    transition: transform var(--md-transition--fast), box-shadow var(--md-transition--fast);
  }

  .post-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .post-item a {
    color: inherit;
    text-decoration: none;
    display: flex;
    gap: var(--md-spacing-unit--lg);
  }

  .post-item-image {
    flex-shrink: 0;
    width: 200px;
    overflow: hidden;
    background-color: var(--md-color--spirits--100);
  }

  .post-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--md-transition--reg);
  }

  .post-item:hover .post-item-image img {
    transform: scale(1.05);
  }

  .post-item-content {
    flex: 1;
    padding: var(--md-spacing-unit--xl);
  }

  .post-item h2 {
    margin-bottom: var(--md-spacing-unit--sm);
    color: var(--blog-text);
  }

  .post-item:hover h2 {
    color: var(--blog-primary);
  }

  .post-excerpt {
    color: var(--blog-text-muted);
    margin-bottom: var(--md-spacing-unit--md);
  }

  .post-item .post-meta {
    display: flex;
    align-items: center;
    gap: var(--md-spacing-unit--sm);
    flex-wrap: wrap;
    font-size: var(--md-font-size--body2);
    color: var(--blog-text-muted);
  }

  @media (max-width: 768px) {
    .post-item a {
      flex-direction: column;
    }

    .post-item-image {
      width: 100%;
      height: 200px;
    }
  }

  .separator {
    color: var(--md-color--spirits--400);
  }

  .tags {
    display: flex;
    gap: var(--md-spacing-unit--xs);
    flex-wrap: wrap;
  }

  .tag {
    background-color: var(--md-color--spirits--100);
    padding: 2px var(--md-spacing-unit--xs);
    border-radius: var(--md-border-radius--xs);
    font-size: var(--md-font-size--micro2);
  }

  .empty-state {
    text-align: center;
    padding: var(--md-spacing-unit--6xl) 0;
    color: var(--blog-text-muted);
  }

  @media (max-width: 768px) {
    .post-meta {
      font-size: var(--md-font-size--micro1);
    }
  }
</style>
